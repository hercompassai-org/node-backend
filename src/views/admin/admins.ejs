<%- include("../components/adminHeader", { title: title }) %>
    <%- include("../components/adminSidebar") %>

        <main class="app-main overflow-hidden">
            <!-- Content Header -->
            <div class="app-content-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Admins</h3>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Admins Table -->
            <div class="row g-3 mx-2">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-person-badge"></i> Admin Users
                            </h5>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Full Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Last seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Loading admins...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Admin Modal -->
            <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="adminModalLabel">Add Admin</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="adminForm">
                                <input type="hidden" id="adminId" value="">
                                <div class="mb-3">
                                    <label for="adminFullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="adminFullName" >
                                </div>
                                <div class="mb-3">
                                    <label for="adminEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="adminEmail" >
                                </div>
                                <div class="mb-3">
                                    <label for="adminRole" class="form-label">Role</label>
                                    <select class="form-select" id="adminRole" >
                                        <option value="admin">Admin</option>
                                        <option value="product_manager">Product Manager</option>
                                        <option value="clinical_reviewer">Clinical Reviewer</option>
                                        <option value="community_moderator">Community Moderator</option>
                                        <option value="growth_marketer">Growth Marketer</option>
                                        <option value="support_agent">Support Agent</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="adminPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="adminPassword">
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Save</button>
                                    <button type="button" class="btn btn-outline-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const tableBody = document.getElementById("adminsTableBody");
                const adminModal = new bootstrap.Modal(document.getElementById("adminModal"));
                const adminForm = document.getElementById("adminForm");

                async function loadAdmins() {
                    try {
                        const res = await fetch("http://localhost:5000/api/admins");
                        const data = await res.json();
                        if (!data.success || !data.data.length) {
                            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No admin users found.</td></tr>`;
                            return;
                        }

                        tableBody.innerHTML = data.data.map((admin, index) => `
                <tr data-admin-id="${admin.id}">
                    <td>${index + 1}</td>
                    <td>${admin.full_name || "-"}</td>
                    <td>${admin.email}</td>
                    <td><span class="badge bg-primary">${admin.role}</span></td>
                    <td>${formatWhatsAppTime(admin.last_active)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info editBtn"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger deleteBtn"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join("");
                    } catch (err) {
                        console.error(err);
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load admin users.</td></tr>`;
                    }
                }

                loadAdmins();

                // Open modal for Add
                document.getElementById("addAdminBtn").addEventListener("click", () => {
                    document.getElementById("adminModalLabel").textContent = "Add Admin";
                    adminForm.reset();
                    document.getElementById("adminId").value = "";
                    adminModal.show();
                });

                // Edit / Delete
                tableBody.addEventListener("click", async (e) => {
                    const tr = e.target.closest("tr");
                    if (!tr) return;
                    const adminId = tr.dataset.adminId;

                    // Edit
                    if (e.target.closest(".editBtn")) {
                        try {
                            const res = await fetch(`http://localhost:5000/api/admins/${adminId}`);
                            const data = await res.json();
                            if (!data.success) return alert("User not found");
                            const admin = data.admin;
                            document.getElementById("adminModalLabel").textContent = "Edit Admin";
                            document.getElementById("adminId").value = admin.id;
                            document.getElementById("adminFullName").value = admin.full_name || "";
                            document.getElementById("adminEmail").value = admin.email || "";
                            document.getElementById("adminRole").value = admin.role || "admin";
                            document.getElementById("adminPassword").value = "";
                            adminModal.show();
                        } catch (err) { console.error(err); }
                    }

                    // Delete
                    if (e.target.closest(".deleteBtn")) {
                        if (!confirm("Are you sure you want to delete this admin?")) return;
                        try {
                            const res = await fetch(`http://localhost:5000/api/admins/delete/${adminId}`, {
                                method: "GET"
                            });
                            const data = await res.json();
                            if (data.success) {
                                alert("Admin deleted");
                                loadAdmins();
                            } else {
                                alert(data.message || "Failed to delete admin");
                            }
                        } catch (err) { console.error(err); alert("Error deleting admin"); }
                    }
                });

                adminForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const id = document.getElementById("adminId").value;
                    const payload = {
                        full_name: document.getElementById("adminFullName").value,
                        email: document.getElementById("adminEmail").value,
                        role: document.getElementById("adminRole").value,
                        password: document.getElementById("adminPassword").value
                    };

                    try {
                        const url = id
                            ? `http://localhost:5000/api/admins/update/${id}`
                            : `http://localhost:5000/api/admins/add`;
                            const method = id ? "PUT" : "POST";
                        const res = await fetch(url, {
                            method,
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert(id ? "Admin updated" : "Admin created");
                            adminModal.hide();
                            loadAdmins();
                        } else {
                            alert(data.message || "Operation failed");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error saving admin");
                    }
                });
            });
        </script>

        <%- include("../components/adminFooter") %>